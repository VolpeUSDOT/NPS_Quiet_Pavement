---
title: "Passby Noise Across Frequencies"
output: 
  html_document:
    self_contained: true
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
---

<!-- saved from url=(0014)about:internet -->
<!-- This needs to be manually added to the second line of the html -->

<!-- 
TODO possibly:
- Repeat all for onboard measurements
- Use 2019 data in addition to 2018
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, message=F)

library(tidyverse)
library(ggplot2)
library(grid)
require(gridExtra)
library(knitr)
library(kableExtra)
library(gtable)


codeloc = ifelse(file.exists('~/git/NPS_Quiet_Pavement'),
                 "~/git/NPS_Quiet_Pavement", "~/GitHub/NPS_Quiet_Pavement")

rootdir <- 'C:/Quiet_Pavement_Local'
knitr::opts_knit$set(root.dir = rootdir)

# Read in data prepared by Initial EDA Exploratory.ipynb, and drop the first column of rownames.
predictors <- read.csv(file.path(rootdir, 'MANOVA_Predictors.csv')); predictors <- predictors[-grep('^X$', names(predictors))]

# Format year
predictors$Year <- factor(predictors$Year, labels = c('2016', '2018', '2019')) # From 0, 1, 2

LZFeq <- read.csv(file.path(rootdir, 'MANOVA_LZFeq.csv')); LZFeq <- LZFeq[-grep('^X$', names(LZFeq))] 
LZFMax <- read.csv(file.path(rootdir, 'MANOVA_LZFMax.csv')); LZFMax <- LZFMax[-grep('^X$', names(LZFMax))]

# Bind predictors together with response values for easier manipulation
LZFeq <- data.frame(predictors, LZFeq)
LZFMax <- data.frame(predictors, LZFMax)

LZFeq <- LZFeq %>% mutate(macro_treatment = ifelse(Microsurfacing == 1, 'Microsurfacing', 'Chip.Seal')) 
LZFMax <- LZFMax %>% mutate(macro_treatment = ifelse(Microsurfacing == 1, 'Microsurfacing', 'Chip.Seal')) 

# Convert to long format. Organize by treatment, with four levels for the treatments in 2018. 
# LZFeq_l <- LZFeq %>% 
#   gather(key = yr_treatment, value, X3.8in.Chip.Seal:Type.III.Microsurfacing) %>%
#   mutate(macro_treatment = ifelse(Microsurfacing == 1, 'Microsurfacing', 'Chip.Seal')) %>%
#   select(-Chip.Seal, -Microsurfacing, -value)

# Manual loop. gather is not working as expected (grouping across years)
levs = c('X3.8in.Chip.Seal', 'X1.4in.Chip.Seal', 'Type.II.Microsurfacing', 'Type.III.Microsurfacing')
cols = names(LZFeq)[c(1:6, 11:48)]

LZFeq_l <- vector()
for(l in levs){
  ll = LZFeq[LZFeq[l] == 1, cols]
  ll$treatment = l
  LZFeq_l = rbind(LZFeq_l, ll)
  
}

# LZFMax_l <- LZFMax %>% 
#   gather(key = treatment, value, X3.8in.Chip.Seal:Type.III.Microsurfacing) %>%
#   mutate(macro_treatment = ifelse(Microsurfacing == 1, 'Microsurfacing', 'Chip.Seal')) %>%
#   select(-Chip.Seal, -Microsurfacing, -value)

cols = names(LZFMax)[c(1:6, 11:48)]

LZFMax_l <- vector()
for(l in levs){
  ll = LZFMax[LZFMax[l] == 1, cols]
  ll$treatment = l
  LZFMax_l = rbind(LZFMax_l, ll)
}

# Change treatment level for 2016 to baseline_chipseal
LZFeq_l <- LZFeq_l %>%
  mutate(treatment = ifelse(Year == '2016', 'baseline_chipseal', treatment))

LZFMax_l <- LZFMax_l %>%
  mutate(treatment = ifelse(Year == '2016', 'baseline_chipseal', treatment))


```

# Overview

Goal is to assess the noise measurements from passby measurements in 2018, where four quiet pavement treatments were applied to test areas: 1/4 in chip seal, 3/8 in chip seal, Type II microsurfacing, and Type III microsurfacing. 

There are eight sites, and four pavement treatments; each pavement treatment is replicated at two sites. Sound intensity was measured pre-treatment and post-treatment.

In the original assessment, overall the Type II microsurfacing was found to reduce overall sound intensity sound from OBSI measurements from 99.2 dB on average to 97.6. Other treatments did not on average reduce sound levels.

This analysis focuses on the observational passby data, where vehicle type varies, and assesses the effects of speed and pavement temperature in addition to experimental treatments.

In the table below, SD_pavetemp is not applicable when the value is 0, because the same pavement temperature measurement was used throughout the trial. 2019 data are shown but only 2016 and 2018 data are used for statistical analyses. These analyses exclude non-passenger car vehicle types (i.e., bus or motorcycle measurements), which occurred infrequently and therefore vehicle type could not be used as a covariate in the analyses.


```{r summary_vals}
Feq_summary <- LZFeq_l %>%
  group_by(Year, Treatment = treatment) %>%  
  summarize('N total' = n(),
            'N autos' = sum(vehtype == 1),
            'Mean speed' = mean(speed),
            'SD speed' = sd(speed),
            'Mean pavement temp' = mean(pavetemp),
            'SD pavement temp' = sd(pavetemp))


Feq_summary$Treatment <- sub("baseline_chipseal", "Baseline - Chip Seal", Feq_summary$Treatment)
Feq_summary$Treatment <- sub("Type.II\\.", "Type II ", Feq_summary$Treatment)
Feq_summary$Treatment <- sub("Type.III.", "Type III ", Feq_summary$Treatment)
Feq_summary$Treatment <- sub("X1.4in.", "1/4 in ", Feq_summary$Treatment)
Feq_summary$Treatment <- sub("X3.8in.", "3/8 in ", Feq_summary$Treatment)
Feq_summary$Treatment <- sub("\\.", " ", Feq_summary$Treatment)


kable(Feq_summary,
      caption = "Summary of passby data collected by year and treatment.",
      digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) 

```

# MANOVA Analysis with LZFeq

```{r manova_1 with LZFeq}

LZFeq_l = filter(LZFeq_l, Year !="2019")

Feq.man.macro <- manova(cbind(X63.0,X80.0,X100.0,X125.0,X160.0,X200.0,X250.0,X315.0,X400.0,X500.0,
                        X630.0,X800.0,X1000.0,X1250.0,X1600.0,X2000.0,X2500.0,X3150.0,X4000.0,
                        X5000.0,X6300.0,X8000.0,X10000.0,X12500.0,X16000.0,X20000.0)~
                    macro_treatment + pavetemp * speed , data = LZFeq_l)


Feq.man.micro <- manova(cbind(X63.0,X80.0,X100.0,X125.0,X160.0,X200.0,X250.0,X315.0,X400.0,X500.0,
                        X630.0,X800.0,X1000.0,X1250.0,X1600.0,X2000.0,X2500.0,X3150.0,X4000.0,
                        X5000.0,X6300.0,X8000.0,X10000.0,X12500.0,X16000.0,X20000.0)~
                      treatment + pavetemp * speed, data = LZFeq_l)


Feq.man.micro2 <- manova(cbind(X63.0,X80.0,X100.0,X125.0,X160.0,X200.0,X250.0,X315.0,X400.0,X500.0,
                        X630.0,X800.0,X1000.0,X1250.0,X1600.0,X2000.0,X2500.0,X3150.0,X4000.0,
                        X5000.0,X6300.0,X8000.0,X10000.0,X12500.0,X16000.0,X20000.0)~
                      treatment + pavetemp * speed + treatment:speed, data = LZFeq_l)

macro.coeff = coefficients(Feq.man.macro)
micro.coeff = coefficients(Feq.man.micro2)
```

Using MANOVA, we see that there are strong effects of all the predictors on noise values across the frequencies. The table shows the summary of the statistical test for the difference in sound intensity across frequencies attributable to each of the predictors: pavement temperature, speed, treatment, and the statistical interactions between temperature and speed, and between treatment and speed. All predictors were statistically significant, including the interactive effects of speed and temperature, and speed and treatment.

Pillai's trace is a test statistic used in multivariate analyses. It is based on the eigenvalues associated with each predictor, across all the sound intensity frequencies. A larger value indicates that this predictor explains more of the difference in the response data (the matrix of all the sound intensity levels across frequencies). In order to interpret the statistical significance of this test statistic, we examine the p-value. This represents whether the test statistic is larger than expected by chance; a p-value less than 0.05 is considered statistically significant. 

Frequencies from 63 Hz to 20 kHz were used for this analysis, covering 26 1/3 octave band frequencies. 

```{r overall summary}
# summary(Feq.man.macro)

# summary(Feq.man.micro)

summary(Feq.man.micro2)

```

```{r manova_post_hoc with LZFeq1}
LZFeq_l = filter(LZFeq_l, Year != "2019")

LZFeq.aov.results = vector()
LZFeq.aov.stderr = vector()
frequencies = vector()
LZFeq.aov.predvals = vector()
LZFeq.aov.predse = vector()

# Creating 'standardized' values using predict. This evens out the pavetemp and speed to a uniform comparison
pt = 90
sp = 50

pred_frame = expand.grid(treatment = unique(LZFeq_l$treatment),
                         speed = sp,
                         pavetemp = pt)


for (freq in names(LZFeq_l[18:43])){
  # freq = names(LZFeq_l[18])
  an.results = lm(LZFeq_l[[freq]] ~ treatment * speed + pavetemp * speed, data = LZFeq_l)
  
  frequencies = rbind(frequencies, c(as.numeric(substr(freq, 2, nchar(freq)))))
  LZFeq.aov.results = rbind(LZFeq.aov.results, coef(an.results))
  LZFeq.aov.stderr = rbind(LZFeq.aov.stderr, coef(summary(an.results))[,"Std. Error"])
  
  # Predict 
  pred = predict(an.results, pred_frame, se.fit = T, interval = 'none')
  LZFeq.aov.predvals = rbind(LZFeq.aov.predvals, pred$fit)
  LZFeq.aov.predse = rbind(LZFeq.aov.predse, pred$se.fit)  
  
}

LZFeq.aov.results = data.frame(LZFeq.aov.results)
LZFeq.aov.results = cbind(frequency = frequencies, LZFeq.aov.results)

LZFeq.aov.stderr = data.frame(LZFeq.aov.stderr)
LZFeq.aov.stderr = cbind(frequency = frequencies, LZFeq.aov.stderr)

LZFeq.aov.predvals = data.frame(LZFeq.aov.predvals)
names(LZFeq.aov.predvals) = pred_frame$treatment
LZFeq.aov.predvals = cbind(frequency = frequencies, LZFeq.aov.predvals)

LZFeq.aov.predse = data.frame(LZFeq.aov.predse)
names(LZFeq.aov.predse) = pred_frame$treatment
LZFeq.aov.predse = cbind(frequency = frequencies, LZFeq.aov.predse)

# Write output to files
names(LZFeq.aov.results)[grep('Intercept', names(LZFeq.aov.results))] = 'Baseline'
names(LZFeq.aov.stderr)[grep('Intercept', names(LZFeq.aov.stderr))] = 'Baseline'

write.csv(LZFeq.aov.results, file.path(rootdir, 'LZFeq_ANOVA_Coefficients.csv'), row.names = F)
write.csv(LZFeq.aov.stderr, file.path(rootdir, 'LZFeq_ANOVA_StdErr.csv'), row.names = F)

write.csv(LZFeq.aov.predvals, file.path(rootdir, 'LZFeq_ANOVA_PredictedVals.csv'), row.names = F)
write.csv(LZFeq.aov.predse, file.path(rootdir, 'LZFeq_ANOVA_PredictedVals_StdErr.csv'), row.names = F)

``` 

## Post-hoc ANOVAs by LZFeq Frequency

Plotting ANOVA change in sound intensity from pre-treatment for LZFeq.

Response variables: treatment, pavement temperature, and speed, as well as the interactions between treatment and speed, pavement temperature and speed.

The plots are generated from the output of the statistical models, holding pavement temperature constant at 90 degrees and speed constant at 50 mph. The change in sound intensity is calculated as the difference between the predicted sound intensity at 90 degrees and 50 mph for a particular treatment, compared to the baseline pavement conditions in 2016 in the same conditions. The error bars are the standard errors for predicted sound intensity levels.

The predicted values at these conditions are saved as `LZFeq_ANOVA_PredictedVals.csv` and `LZFeq_ANOVA_PredictedVals_StdErr.csv`

Compared with Figure 18 in DEVA_QPP_Report_Nov2106-May-2018_draft2 9-5-8.pdf.

```{r plotting_change_LZFeq, fig.height = 20, fig.width = 15}

y_range = c(-10, 10)

# Use predvals. Subtract from baseline to show difference.
predvals = LZFeq.aov.predvals
predse = LZFeq.aov.predse

predvals[,3:6] = predvals[,3:6] - predvals[,2]

#Set colors for each point for 1/4 in chip seal
CS_1.4_col = c()
CS_1.4_col = ifelse(abs(predvals$X1.4in.Chip.Seal) > predse$X1.4in.Chip.Seal,
       ifelse(predvals$X1.4in.Chip.Seal < 0, "blue", "red"),"gray")

# Plot LZFeq 1/4in Chip Seal.
# Since now we are including interaction between speed and treatment, also add the coefficient for the treatment at 50 mph
LZFeq_Chip.Seal.1.4 = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency,
                      y = X1.4in.Chip.Seal,
                      ymin = X1.4in.Chip.Seal - predse$X1.4in.Chip.Seal,
                      ymax = X1.4in.Chip.Seal + predse$X1.4in.Chip.Seal),
                  colour = CS_1.4_col,
                  size =1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "LZFeq ANOVA 1/4in Chip Seal Coefficients", 
       x = "Frequency (Hz)", 
       y = "Change in Sound Intensity \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0) +
  ylim(y_range[1], y_range[2])

#Set colors for each point in 3/8 in chip seal
CS_3.8_col = c()
CS_3.8_col = ifelse(abs(predvals$X3.8in.Chip.Seal) > predse$X3.8in.Chip.Seal,
       ifelse(predvals$X3.8in.Chip.Seal < 0, "blue", "red"),"gray")

#Plot LZFeq 3/8 in chip seal
LZFeq_Chip.Seal.3.8 = ggplot()+
  geom_pointrange(data = predvals, 
                  aes(x = frequency,
                      y = X3.8in.Chip.Seal,
                      ymin = X3.8in.Chip.Seal - predse$X3.8in.Chip.Seal,
                      ymax =X3.8in.Chip.Seal + predse$X3.8in.Chip.Seal),
                  colour = CS_3.8_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "LZFeq ANOVA 3/8in Chip Seal Coefficients", 
       x = "Frequency (Hz)", 
       y = "Change in Sound Intensity \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

#Set colors for each point in type II microsurfacing
TII_Micro_col = c()
TII_Micro_col = ifelse(abs(predvals$Type.II.Microsurfacing)>predse$Type.II.Microsurfacing,
       ifelse(predvals$Type.II.Microsurfacing<0, "blue", "red"),"gray")

#Plot LZFeq type II microsurfacing
LZFeq_Microsurfacing.II = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.II.Microsurfacing,
                  ymin=Type.II.Microsurfacing - predse$Type.II.Microsurfacing,
                  ymax=Type.II.Microsurfacing + predse$Type.II.Microsurfacing),
                  colour = TII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "LZFeq ANOVA Type II Microsurfacing Coefficients", 
       x = "Frequency (Hz)", 
       y = "Change in Sound Intensity \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

#Set colors for each point in type III microsurfacing
TIII_Micro_col = c()
TIII_Micro_col = ifelse(abs(predvals$Type.III.Microsurfacing)>predse$Type.III.Microsurfacing,
       ifelse(predvals$Type.III.Microsurfacing<0, "blue", "red"),"gray")

#Plot LZFeq Type III microsurfacing
LZFeq_Microsurfacing.III = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.III.Microsurfacing,
                  ymin=Type.III.Microsurfacing - predse$Type.III.Microsurfacing,
                  ymax=Type.III.Microsurfacing + predse$Type.III.Microsurfacing),
                  colour = TIII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "LZFeq ANOVA Type III Microsurfacing Coefficients", 
       x = "Frequency (Hz)", 
       y = "Change in Sound Intensity \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

#Arrange plots in grid
grid.arrange(LZFeq_Chip.Seal.1.4,LZFeq_Chip.Seal.3.8,LZFeq_Microsurfacing.II, LZFeq_Microsurfacing.III, nrow = 4)

```

# MANOVA Analysis with LZFMax

```{r manova with LZFMax_l}
LZFMax_l = filter(LZFMax_l, Year !="2019")

# Feq.man.macro <- manova(cbind(X63.0,X80.0,X100.0,X125.0,X160.0,X200.0,X250.0,X315.0,X400.0,X500.0,
#                         X630.0,X800.0,X1000.0,X1250.0,X1600.0,X2000.0,X2500.0,X3150.0,X4000.0,
#                         X5000.0,X6300.0,X8000.0,X10000.0,X12500.0,X16000.0,X20000.0)~
#                     macro_treatment + pavetemp*speed + Year, data = LZFMax_l)
# summary(Feq.man.macro)

# Feq.man.micro <- manova(cbind(X63.0,X80.0,X100.0,X125.0,X160.0,X200.0,X250.0,X315.0,X400.0,X500.0,
#                         X630.0,X800.0,X1000.0,X1250.0,X1600.0,X2000.0,X2500.0,X3150.0,X4000.0,
#                         X5000.0,X6300.0,X8000.0,X10000.0,X12500.0,X16000.0,X20000.0)~
#                       treatment + pavetemp * speed, data = LZFMax_l)
# summary(Feq.man.micro)

Fmax.man.micro <- manova(cbind(X63.0,X80.0,X100.0,X125.0,X160.0,X200.0,X250.0,X315.0,X400.0,X500.0,
                        X630.0,X800.0,X1000.0,X1250.0,X1600.0,X2000.0,X2500.0,X3150.0,X4000.0,
                        X5000.0,X6300.0,X8000.0,X10000.0,X12500.0,X16000.0,X20000.0)~
                      treatment + pavetemp * speed + treatment:speed, data = LZFMax_l)

micro.coeff = coefficients(Fmax.man.micro)

summary(Fmax.man.micro)

```

```{r manova_post_hoc with LZFMax_l}
LZFMax_l = filter(LZFMax_l, Year != "2019")

LZFMax.aov.results = vector()
LZFMax.aov.stderr = vector()
frequencies = vector()
LZFMax.aov.predvals = vector()
LZFMax.aov.predse = vector()

# Creating 'standardized' values using predict. This evens out the pavetemp and speed to a uniform comparison
pt = 90
sp = 50

pred_frame = expand.grid(treatment = unique(LZFeq_l$treatment),
                         speed = sp,
                         pavetemp = pt)

for (freq in names(LZFMax_l[18:43])){
  # freq = names(LZFMax_l[18])
  an.results = lm(LZFMax_l[[freq]] ~ treatment * speed + pavetemp * speed, data = LZFMax_l)
  
  frequencies = rbind(frequencies, c(as.numeric(substr(freq, 2, nchar(freq)))))
  LZFMax.aov.results = rbind(LZFMax.aov.results, coef(an.results))
  LZFMax.aov.stderr = rbind(LZFMax.aov.stderr, coef(summary(an.results))[,"Std. Error"])
  
  # Predict 
  pred = predict(an.results, pred_frame, se.fit = T, interval = 'none')
  LZFMax.aov.predvals = rbind(LZFMax.aov.predvals, pred$fit)
  LZFMax.aov.predse = rbind(LZFMax.aov.predse, pred$se.fit)  
  
}

LZFMax.aov.results = data.frame(LZFMax.aov.results)
LZFMax.aov.results = cbind(frequency = frequencies, LZFMax.aov.results)

LZFMax.aov.stderr = data.frame(LZFMax.aov.stderr)
LZFMax.aov.stderr = cbind(frequency = frequencies, LZFMax.aov.stderr)

LZFMax.aov.predvals = data.frame(LZFMax.aov.predvals)
names(LZFMax.aov.predvals) = pred_frame$treatment
LZFMax.aov.predvals = cbind(frequency = frequencies, LZFMax.aov.predvals)

LZFMax.aov.predse = data.frame(LZFMax.aov.predse)
names(LZFMax.aov.predse) = pred_frame$treatment
LZFMax.aov.predse = cbind(frequency = frequencies, LZFMax.aov.predse)

# Write output to files
names(LZFMax.aov.results)[grep('Intercept', names(LZFMax.aov.results))] = 'Baseline'
names(LZFMax.aov.stderr)[grep('Intercept', names(LZFMax.aov.stderr))] = 'Baseline'

write.csv(LZFMax.aov.results, file.path(rootdir, 'LZFMax_ANOVA_Coefficients.csv'), row.names = F)
write.csv(LZFMax.aov.stderr, file.path(rootdir, 'LZFMax_ANOVA_StdErr.csv'), row.names = F)

write.csv(LZFMax.aov.predvals, file.path(rootdir, 'LZFMax_ANOVA_PredictedVals.csv'), row.names = F)
write.csv(LZFMax.aov.predse, file.path(rootdir, 'LZFMax_ANOVA_PredictedVals_StdErr.csv'), row.names = F)
```


## Post-hoc ANOVAs by LZFMax Frequency

Plotting ANOVA coefficients of change in sound intensity from pretreatment for LZFMax

Predictors: Treatment type, pavement temperature, and speed. Treatment x speed and pavement temperature x speed are included as predictors.

```{r plotting_change_LZFMax, fig.height = 20, fig.width = 15}

y_range = c(-12, 10)

# Use predvals. Subtract from baseline to show difference.
predvals = LZFMax.aov.predvals
predse = LZFMax.aov.predse

predvals[,3:6] = predvals[,3:6] - predvals[,2]

#Set colors for each point for 1/4 in chip seal
CS_1.4_col = c()
CS_1.4_col = ifelse(abs(predvals$X1.4in.Chip.Seal) > predse$X1.4in.Chip.Seal,
       ifelse(predvals$X1.4in.Chip.Seal < 0, "blue", "red"),"gray")

# Plot LZFMax 1/4in Chip Seal.
# Since now we are including interaction between speed and treatment, also add the coefficient for the treatment at 50 mph
LZFMax_Chip.Seal.1.4 = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency,
                      y = X1.4in.Chip.Seal,
                      ymin = X1.4in.Chip.Seal - predse$X1.4in.Chip.Seal,
                      ymax = X1.4in.Chip.Seal + predse$X1.4in.Chip.Seal),
                  colour = CS_1.4_col,
                  size =1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "LZFMax ANOVA 1/4in Chip Seal Coefficients", 
       x = "Frequency (Hz)", 
       y = "Change in Sound Intensity \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0) +
  ylim(y_range[1], y_range[2])

#Set colors for each point in 3/8 in chip seal
CS_3.8_col = c()
CS_3.8_col = ifelse(abs(predvals$X3.8in.Chip.Seal) > predse$X3.8in.Chip.Seal,
       ifelse(predvals$X3.8in.Chip.Seal < 0, "blue", "red"),"gray")

#Plot LZFMax 3/8 in chip seal
LZFMax_Chip.Seal.3.8 = ggplot()+
  geom_pointrange(data = predvals, 
                  aes(x = frequency,
                      y = X3.8in.Chip.Seal,
                      ymin = X3.8in.Chip.Seal - predse$X3.8in.Chip.Seal,
                      ymax =X3.8in.Chip.Seal + predse$X3.8in.Chip.Seal),
                  colour = CS_3.8_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "LZFMax ANOVA 3/8in Chip Seal Coefficients", 
       x = "Frequency (Hz)", 
       y = "Change in Sound Intensity \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

#Set colors for each point in type II microsurfacing
TII_Micro_col = c()
TII_Micro_col = ifelse(abs(predvals$Type.II.Microsurfacing)>predse$Type.II.Microsurfacing,
       ifelse(predvals$Type.II.Microsurfacing<0, "blue", "red"),"gray")

#Plot LZFMax type II microsurfacing
LZFMax_Microsurfacing.II = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.II.Microsurfacing,
                  ymin=Type.II.Microsurfacing - predse$Type.II.Microsurfacing,
                  ymax=Type.II.Microsurfacing + predse$Type.II.Microsurfacing),
                  colour = TII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "LZFMax ANOVA Type II Microsurfacing Coefficients", 
       x = "Frequency (Hz)", 
       y = "Change in Sound Intensity \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

#Set colors for each point in type III microsurfacing
TIII_Micro_col = c()
TIII_Micro_col = ifelse(abs(predvals$Type.III.Microsurfacing)>predse$Type.III.Microsurfacing,
       ifelse(predvals$Type.III.Microsurfacing<0, "blue", "red"),"gray")

#Plot LZFMax Type III microsurfacing
LZFMax_Microsurfacing.III = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.III.Microsurfacing,
                  ymin=Type.III.Microsurfacing - predse$Type.III.Microsurfacing,
                  ymax=Type.III.Microsurfacing + predse$Type.III.Microsurfacing),
                  colour = TIII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "LZFMax ANOVA Type III Microsurfacing Coefficients", 
       x = "Frequency (Hz)", 
       y = "Change in Sound Intensity \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

#Arrange plots in grid
grid.arrange(LZFMax_Chip.Seal.1.4,LZFMax_Chip.Seal.3.8,LZFMax_Microsurfacing.II, LZFMax_Microsurfacing.III, nrow = 4)

```


