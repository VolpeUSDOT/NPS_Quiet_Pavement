---
title: "Death Valley Wayside Single Pass-By Analysis of Variance across Time, Frequency, and Pavement Conditions"
output: 
  html_document:
    self_contained: true
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
---

<!-- saved from url=(0014)about:internet -->
<!-- This needs to be manually added to the second line of the html -->

<!-- 
DONE: commented out all manipulations of LZFmax metric

TODO:
- Validate calculation of predvals from coefficients for manual calculation - Done, see Manual_Predvals_Calcs.R
- Look at 95% confidence intervals instead of +- 1 standard error. SEM = s.d. / sqrt (n). 95% confidence interval at the level of individual observation is s.d. * 1.96, at the level of a mean value is s.e. * 1.96
- implement analysis for 2021 data 

-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, message=F)

library(tidyverse)
library(ggplot2)
library(grid)
require(gridExtra)
library(knitr)
library(kableExtra)
library(gtable)
library(plotly)

codeloc = ifelse(file.exists('~/git/NPS_Quiet_Pavement'),
                 "~/git/NPS_Quiet_Pavement", "~/GitHub/NPS_Quiet_Pavement")

rootdir <- file.path(codeloc, 'Data')
knitr::opts_knit$set(root.dir = rootdir)

## Read in data and drop the first column of rownames
predictors <- read.csv(file.path(rootdir, 'MANOVA_Predictors.csv')); predictors <- predictors[-grep('^X$', names(predictors))]

## Format year
predictors$Year <- factor(predictors$Year, labels = c('2016', '2018', '2019', '2021')) # From 0, 1, 2, 3

LZFeq <- read.csv(file.path(rootdir, 'MANOVA_LZFeq.csv')); LZFeq <- LZFeq[-grep('^X$', names(LZFeq))] 
#LZFMax <- read.csv(file.path(rootdir, 'MANOVA_LZFMax.csv')); LZFMax <- LZFMax[-grep('^X$', names(LZFMax))]

## Bind predictors together with response values for easier manipulation
LZFeq <- data.frame(predictors, LZFeq)
#LZFMax <- data.frame(predictors, LZFMax)

LZFeq <- LZFeq %>% mutate(macro_treatment = ifelse(Microsurfacing == 1, 'Microsurfacing', 'Chip.Seal')) 
#LZFMax <- LZFMax %>% mutate(macro_treatment = ifelse(Microsurfacing == 1, 'Microsurfacing', 'Chip.Seal')) 

## generate treatment column data and append to LZFeq to create LZFeq_l...I think
levs = c('X3.8in.Chip.Seal', 'X1.4in.Chip.Seal', 'Type.II.Microsurfacing', 'Type.III.Microsurfacing')
cols = names(LZFeq)[c(1:6, 11:48)]

LZFeq_l <- vector()
for(l in levs){
  ll = LZFeq[LZFeq[l] == 1, cols]
  ll$treatment = l
  LZFeq_l = rbind(LZFeq_l, ll)
  
}

#cols = names(LZFMax)[c(1:6, 11:48)]
# 
#LZFMax_l <- vector()
#for(l in levs){
#  ll = LZFMax[LZFMax[l] == 1, cols]
#  ll$treatment = l
#  LZFMax_l = rbind(LZFMax_l, ll)
#}

## Change treatment level for 2016 to baseline_chipseal
LZFeq_l <- LZFeq_l %>%
  mutate(treatment = ifelse(Year == '2016', 'baseline_chipseal', treatment))

#LZFMax_l <- LZFMax_l %>%
#  mutate(treatment = ifelse(Year == '2016', 'baseline_chipseal', treatment))

```

# Overview

Goal is to assess the noise measurements from wayside single pass-by measurements in 2016-2021. In 2018, four pavement surface treatments were applied to test areas: 1/4" chip seal, 3/8" chip seal, Type II microsurfacing, and Type III microsurfacing. 

There are eight sites, and four surface treatments; each surface treatment is replicated at two sites. Sound pressure levels were measured pre-treatment and post-treatment.

In the original assessment, the Type II microsurfacing was found to reduce overall sound intensity sound from OBSI measurements on average, from 99.2 to 97.6 dB. Other treatments did not reduce sound intensity levels, on average.

This analysis focuses on the wayside single pass-by data and assesses the effects of speed and pavement temperature in addition to surface treatments.

In the table below, SD_pavetemp is not applicable when the value is zero because the same pavement temperature was measured throughout the trial. These analyses exclude non-passenger car vehicle types (i.e., bus or motorcycle measurements), because they occurred infrequently and therefore vehicle type could not be used as a covariate in the analyses.


```{r summary_vals}
LZFeq_summary <- LZFeq_l %>%
  group_by(Year, Treatment = treatment) %>%  
  summarize('N autos' = sum(vehtype == 1),
            'Mean Speed (mph)' = mean(speed),
            'Speed SD (mph)' = sd(speed),
            'Mean Pavement Temp (deg F)' = mean(pavetemp),
            'Pavement Temp SD (deg F)' = sd(pavetemp))


LZFeq_summary$Treatment <- sub("baseline_chipseal", "Baseline - Chip Seal", LZFeq_summary$Treatment)
LZFeq_summary$Treatment <- sub("Type.II\\.", "Type II ", LZFeq_summary$Treatment)
LZFeq_summary$Treatment <- sub("Type.III.", "Type III ", LZFeq_summary$Treatment)
LZFeq_summary$Treatment <- sub("X1.4in.", "1/4 in ", LZFeq_summary$Treatment)
LZFeq_summary$Treatment <- sub("X3.8in.", "3/8 in ", LZFeq_summary$Treatment)
LZFeq_summary$Treatment <- sub("\\.", " ", LZFeq_summary$Treatment)


kable(LZFeq_summary,
      caption = "Summary of pass-by data collected by year and surface treatment",
      digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) 

```

# 2018 MANOVA Analysis with LZFeq

```{r manova_1 with LZFeq model selection}

LZFeq_l_18 = filter(LZFeq_l, Year %in% c("2016", "2018")) # working dataset for current analysis is 2016 to 2018 comparison dataset

## conduct partial F test of full model with all predictors against concise models with fewer predictors
## (pavetemp:treatment interaction not possible because one site had constant pavetemp)
full.model = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                     X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed +  pavetemp + pavetemp:speed + treatment:speed, data = LZFeq_l_18)

no.pavetemp = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                      X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed, data = LZFeq_l_18)

#anova(full.model,no.pavetemp) # partial F-stat is significant, thus the no.interactions model leaves variance unexplained

no.interactions = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                      X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp, data = LZFeq_l_18)

#anova(full.model,no.interactions) # partial F-stat is significant, thus the no.interactions model leaves variance unexplained

treatment.speed = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                     X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp + treatment:speed, data = LZFeq_l_18)

#anova(full.model,treatment.speed) # partial F-stat is significant, thus the treatment.speed model leaves variance unexplained

speed.pavetemp = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                    X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp+ pavetemp:speed, data = LZFeq_l_18)

#anova(full.model,speed.pavetemp) # partial F-stat is significant, thus the speed.pavetemp model leaves variance unexplained

final.model = full.model # all concise models had significant partial F-statistics, therefore the full model is the best model

finalmodel.coeff = coefficients(final.model)

LZFeq.man.macrotreatment <- manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                        X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000,
                        X5000,X6300,X8000,X10000,X12500,X16000,X20000)~
                    macro_treatment + pavetemp * speed , data = LZFeq_l_18)


LZFeq.man.microtreatment <- manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                        X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000,
                        X5000,X6300,X8000,X10000,X12500,X16000,X20000)~
                      treatment + pavetemp * speed, data = LZFeq_l_18)


LZFeq.man.microtreatment2 <- manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                        X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000,
                        X5000,X6300,X8000,X10000,X12500,X16000,X20000)~
                      treatment + pavetemp * speed + treatment:speed, data = LZFeq_l_18)

macrotreatment.coeff = coefficients(LZFeq.man.macrotreatment)
microtreatment.coeff = coefficients(LZFeq.man.microtreatment2)
```

Using MANOVA, we see that there are strong effects of all the predictors on noise levels across the frequency spectra. The table shows the summary of the statistical test for the difference in sound pressure level (LZFeq) across all 1/3 octave bands attributable to each of the predictors: pavement temperature, speed, surface treatment, and the statistical interactions between temperature and speed, and between surface treatment and speed. All predictors were statistically significant, including the interactive effects of speed and temperature, and speed and surface treatment.

Pillai's trace is a test statistic used in multivariate analyses. It is based on the eigenvalues associated with each predictor, across all 1/3 octave bands. A larger Pillai's value indicates that this predictor explains more of the difference in the response data (the matrix of all 1/3 octave band LZFeq values). In order to interpret the statistical significance of this test statistic, we examine the p-value. This represents whether the test statistic is larger than expected by chance; a p-value less than 0.05 is considered statistically significant. 

1/3 octave bands from 50 Hz to 20 kHz were used for this analysis. 

```{r overall summary}
# summary(LZFeq.man.macro)

# summary(LZFeq.man.micro)
sum_2018 <- summary(LZFeq.man.microtreatment2)

sum_2018$stats[,2] <- round(sum_2018$stats[,2], 3)
sum_2018$stats[,3] <- round(sum_2018$stats[,3], 3)

sum_2018$stats[,6] <- ifelse(sum_2018$stats[,6] < 0.001, '< 0.001', round(sum_2018$stats[,6], 3))
sum_2018$stats[is.na(sum_2018$stats)] = ""

kable(sum_2018$stats,
      align = 'r',
      caption = "Summary of MANOVA analysis for 1-month post-treatment (2018) compared to pre-treatment (2016)",
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

write.csv(sum_2018$stats, file = 'MANOVA_2018.csv')
                  
```

```{r manova_post_hoc with LZFeq1}
LZFeq.aov.results = vector()
LZFeq.aov.stderr = vector()
OneThirdOBs = vector()
LZFeq.aov.predvals = vector()
LZFeq.aov.predse = vector()

## Creating 'standardized' values using predict. This evens out the pavetemp and speed to a uniform comparison
pt = 90
sp = 50

pred_frame = expand.grid(treatment = unique(LZFeq_l_18$treatment),
                         speed = sp,
                         pavetemp = pt)


for (freq in names(LZFeq_l_18[17:43])){
  # freq = names(LZFeq_l_18[17])
  an.results = lm(LZFeq_l_18[[freq]] ~ treatment * speed + pavetemp * speed, data = LZFeq_l_18)
  
  OneThirdOBs = rbind(OneThirdOBs, c(as.numeric(substr(freq, 2, nchar(freq)))))
  LZFeq.aov.results = rbind(LZFeq.aov.results, coef(an.results))
  LZFeq.aov.stderr = rbind(LZFeq.aov.stderr, coef(summary(an.results))[,"Std. Error"])
  
  ## Predict 
  pred = predict(an.results, pred_frame, se.fit = T, interval = 'none')
  LZFeq.aov.predvals = rbind(LZFeq.aov.predvals, pred$fit)
  LZFeq.aov.predse = rbind(LZFeq.aov.predse, pred$se.fit)  
  
}

LZFeq.aov.results = data.frame(LZFeq.aov.results)
LZFeq.aov.results = cbind(frequency = OneThirdOBs, LZFeq.aov.results)

LZFeq.aov.stderr = data.frame(LZFeq.aov.stderr)
LZFeq.aov.stderr = cbind(frequency = OneThirdOBs, LZFeq.aov.stderr)

LZFeq.aov.predvals = data.frame(LZFeq.aov.predvals)
names(LZFeq.aov.predvals) = pred_frame$treatment
LZFeq.aov.predvals = cbind(frequency = OneThirdOBs, LZFeq.aov.predvals)

LZFeq.aov.predse = data.frame(LZFeq.aov.predse)
names(LZFeq.aov.predse) = pred_frame$treatment
LZFeq.aov.predse = cbind(frequency = OneThirdOBs, LZFeq.aov.predse)

## Write output to files
names(LZFeq.aov.results)[grep('Intercept', names(LZFeq.aov.results))] = 'Baseline'
names(LZFeq.aov.stderr)[grep('Intercept', names(LZFeq.aov.stderr))] = 'Baseline'

write.csv(LZFeq.aov.results, file.path(rootdir, 'LZFeq_2018_ANOVA_Coefficients.csv'), row.names = F)
write.csv(LZFeq.aov.stderr, file.path(rootdir, 'LZFeq_2018_ANOVA_StdErr.csv'), row.names = F)

write.csv(LZFeq.aov.predvals, file.path(rootdir, 'LZFeq_2018_ANOVA_PredictedVals.csv'), row.names = F)
write.csv(LZFeq.aov.predse, file.path(rootdir, 'LZFeq_2018_ANOVA_PredictedVals_StdErr.csv'), row.names = F)

``` 

## Post-hoc ANOVAs by LZFeq Frequency

Plotting ANOVA LZFeq change from pre-treatment.

Response variables: treatment, pavement temperature, and speed, as well as the interactions between treatment and speed, as well as pavement temperature and speed.

The plots are generated from the output of the statistical models, holding pavement temperature constant at 90 degrees and speed constant at 50 mph. The change in LZFeq is calculated as the difference between the predicted sound levels at 90 degrees and 50 mph for a particular treatment, compared to the baseline pavement conditions in 2016 in the same conditions. The error bars are the standard errors for predicted LZFeq values.

The predicted values at these conditions are saved as `LZFeq_2018_ANOVA_PredictedVals.csv` and `LZFeq_2018_ANOVA_PredictedVals_StdErr.csv`

The plots below became Figure 18 in the DEVA QPP 1 month report.

```{r plotting_change_LZFeq, fig.height = 20, fig.width = 15}

y_range = c(-10, 10)

## Use predvals. Subtract from baseline to show difference.
predvals = LZFeq.aov.predvals
predse = LZFeq.aov.predse

predvals[,3:6] = predvals[,3:6] - predvals[,2]

## Set colors for each point for 1/4" chip seal
CS_1.4_col = c()
CS_1.4_col = ifelse(abs(predvals$X1.4in.Chip.Seal) > predse$X1.4in.Chip.Seal,
       ifelse(predvals$X1.4in.Chip.Seal < 0, "blue", "red"),"gray")

## Plot LZFeq 1/4" chip seal
## Since now we are including interaction between speed and treatment, also add the coefficient for the treatment at 50 mph
LZFeq_Chip.Seal.1.4 = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency,
                      y = X1.4in.Chip.Seal,
                      ymin = X1.4in.Chip.Seal - predse$X1.4in.Chip.Seal,
                      ymax = X1.4in.Chip.Seal + predse$X1.4in.Chip.Seal),
                  colour = CS_1.4_col,
                  size =1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = 'One Month LZFeq ANOVA 1/4" Chip Seal Coefficients', 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0) +
  ylim(y_range[1], y_range[2])

## Set colors for each point in 3/8" chip seal
CS_3.8_col = c()
CS_3.8_col = ifelse(abs(predvals$X3.8in.Chip.Seal) > predse$X3.8in.Chip.Seal,
       ifelse(predvals$X3.8in.Chip.Seal < 0, "blue", "red"),"gray")

## Plot LZFeq 3/8" chip seal
LZFeq_Chip.Seal.3.8 = ggplot()+
  geom_pointrange(data = predvals, 
                  aes(x = frequency,
                      y = X3.8in.Chip.Seal,
                      ymin = X3.8in.Chip.Seal - predse$X3.8in.Chip.Seal,
                      ymax =X3.8in.Chip.Seal + predse$X3.8in.Chip.Seal),
                  colour = CS_3.8_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = 'One Month LZFeq ANOVA 3/8" Chip Seal Coefficients', 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Set colors for each point in type II microsurfacing
TII_Micro_col = c()
TII_Micro_col = ifelse(abs(predvals$Type.II.Microsurfacing)>predse$Type.II.Microsurfacing,
       ifelse(predvals$Type.II.Microsurfacing<0, "blue", "red"),"gray")

## Plot LZFeq type II microsurfacing
LZFeq_Microsurfacing.II = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.II.Microsurfacing,
                  ymin=Type.II.Microsurfacing - predse$Type.II.Microsurfacing,
                  ymax=Type.II.Microsurfacing + predse$Type.II.Microsurfacing),
                  colour = TII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "One Month LZFeq ANOVA Type II Microsurfacing Coefficients", 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Set colors for each point in type III microsurfacing
TIII_Micro_col = c()
TIII_Micro_col = ifelse(abs(predvals$Type.III.Microsurfacing)>predse$Type.III.Microsurfacing,
       ifelse(predvals$Type.III.Microsurfacing<0, "blue", "red"),"gray")

## Plot LZFeq Type III microsurfacing
LZFeq_Microsurfacing.III = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.III.Microsurfacing,
                  ymin=Type.III.Microsurfacing - predse$Type.III.Microsurfacing,
                  ymax=Type.III.Microsurfacing + predse$Type.III.Microsurfacing),
                  colour = TIII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "One Month LZFeq ANOVA Type III Microsurfacing Coefficients", 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Arrange plots in grid
grid.arrange(LZFeq_Chip.Seal.1.4,LZFeq_Chip.Seal.3.8,LZFeq_Microsurfacing.II, LZFeq_Microsurfacing.III, nrow = 4)

```

## Plotting standardized curves

The following shows the predicted LZFeq levels at standardized pavement temperature (90 degrees) and vehicle speed (50 mph). Two versions are shown, a point plot and a 'ribbon plot'. Both show the predicted values, +/- 1 standard error. 

The second plot is interactive; clicking on the legend will show or hide a specific treatment.

```{r plotting_curves_LZFeq, fig.height = 8, fig.width = 10}

## Use predvals
predvals = LZFeq.aov.predvals
predse = LZFeq.aov.predse

predvals = gather(predvals, key = 'treatment', value = 'LZFeq',
                  baseline_chipseal, X3.8in.Chip.Seal, X1.4in.Chip.Seal, Type.II.Microsurfacing, Type.III.Microsurfacing)

predse = gather(predse, key = 'treatment', value = 'SE',
                  baseline_chipseal, X3.8in.Chip.Seal, X1.4in.Chip.Seal, Type.II.Microsurfacing, Type.III.Microsurfacing)

predvals = left_join(predvals, predse)

## Plot 

point_plot <- ggplot(predvals, aes(x = frequency,
                     y = LZFeq,
                     color = treatment)) +
  geom_pointrange(aes(ymin = LZFeq - SE,
                      ymax = LZFeq + SE), 
                      size = 1) +
  # geom_smooth() + 
  geom_line() + 
  theme_bw(base_line_size = 1,
           base_size = 15) +
  scale_x_log10() +
  labs(title = "One Month LZFeq by Surface Treatment \nat 90 deg F pavement temperature and 50 mph speed", 
       x = "Frequency (Hz)", 
       y = "LZFeq (dB)")

point_plot

## Ribbons
ribbon_plot <- ggplot(predvals, aes(x = frequency,
                     y = LZFeq,
                     color = treatment)) +
  geom_ribbon(aes(ymin = LZFeq - SE,
              ymax = LZFeq + SE, 
              fill = treatment,
              color = NULL),
              alpha = 0.3) +
    geom_line() + 

  theme_bw(base_line_size = 1,
           base_size = 15) +
  scale_x_log10() +
  labs(title = "One Month LZFeq by Surface Treatment \nat 90 deg F pavement temperature and 50 mph speed", 
       x = "Frequency (Hz)", 
       y = "LZFeq (dB)")

ggplotly(ribbon_plot)

  
```




# 2019 MANOVA Analysis with LZFeq

```{r manova_2019 with LZFeq model selection}

LZFeq_l_19 = filter(LZFeq_l, Year %in% c("2016", "2019")) # save a 2016 to 2019 comparison dataset

## conduct partial F test of full model with all predictors against concise models with fewer predictors
## (pavetemp:treatment interaction not possible because one site had constant pavetemp)
full.model = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                     X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed +  pavetemp + pavetemp:speed + treatment:speed, data = LZFeq_l_19)

no.pavetemp = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                      X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed, data = LZFeq_l_19)

#anova(full.model,no.pavetemp) # partial F-stat is significant, thus the no.interactions model leaves variance unexplained

no.interactions = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                      X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp, data = LZFeq_l_19)

#anova(full.model,no.interactions) # partial F-stat is significant, thus the no.interactions model leaves variance unexplained

treatment.speed = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                     X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp + treatment:speed, data = LZFeq_l_19)

#anova(full.model,treatment.speed) # partial F-stat is significant, thus the treatment.speed model leaves variance unexplained

speed.pavetemp = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                    X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp+ pavetemp:speed, data = LZFeq_l_19)

#anova(full.model,speed.pavetemp) # partial F-stat is significant, thus the speed.pavetemp model leaves variance unexplained

final.model = full.model # all concise models had significant partial F-statistics, therefore the full model is the best model

finalmodel.coeff = coefficients(final.model)

LZFeq.man.microtreatment2 <- manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                        X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000,
                        X5000,X6300,X8000,X10000,X12500,X16000,X20000)~
                      treatment + pavetemp * speed + treatment:speed, data = LZFeq_l_19)

microtreatment.coeff = coefficients(LZFeq.man.microtreatment2)
```

For the 2016 to 2019 comparison, all predictors remained significant, except that the interaction between pavement temperature and speed became only marginally significant (p = 0.076). The variable is retained here for comparison with the previous analysis of 2016 to 2018 data.

```{r overall summary 2019}
# summary(Feq.man.micro2)

sum_2019 <- summary(LZFeq.man.microtreatment2)

sum_2019$stats[,2] <- round(sum_2019$stats[,2], 3)
sum_2019$stats[,3] <- round(sum_2019$stats[,3], 3)

sum_2019$stats[,6] <- ifelse(sum_2019$stats[,6] < 0.001, '< 0.001', round(sum_2019$stats[,6], 3))
sum_2019$stats[is.na(sum_2019$stats)] = ""

kable(sum_2019$stats,
      align = 'r',
      caption = "Summary of MANOVA analysis for 1-year post-treatment (2019) compared to pre-treatment (2016)",
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

write.csv(sum_2019$stats, file = 'MANOVA_2019.csv')
                  

```

```{r manova_post_hoc with LZFeq 2019}
LZFeq.aov.results = vector()
LZFeq.aov.stderr = vector()
OneThirdOBs = vector()
LZFeq.aov.predvals = vector()
LZFeq.aov.predse = vector()

## Creating 'standardized' values using predict. This evens out the pavetemp and speed to a uniform comparison
pt = 90
sp = 50

pred_frame = expand.grid(treatment = unique(LZFeq_l_19$treatment),
                         speed = sp,
                         pavetemp = pt)


for (freq in names(LZFeq_l_19[17:43])){
  # freq = names(LZFeq_l_19[18])
  an.results = lm(LZFeq_l_19[[freq]] ~ treatment * speed + pavetemp * speed, data = LZFeq_l_19)
  
  OneThirdOBs = rbind(OneThirdOBs, c(as.numeric(substr(freq, 2, nchar(freq)))))
  LZFeq.aov.results = rbind(LZFeq.aov.results, coef(an.results))
  LZFeq.aov.stderr = rbind(LZFeq.aov.stderr, coef(summary(an.results))[,"Std. Error"])
  
  ## Predict 
  pred = predict(an.results, pred_frame, se.fit = T, interval = 'none')
  LZFeq.aov.predvals = rbind(LZFeq.aov.predvals, pred$fit)
  LZFeq.aov.predse = rbind(LZFeq.aov.predse, pred$se.fit)  
  
}

LZFeq.aov.results = data.frame(LZFeq.aov.results)
LZFeq.aov.results = cbind(frequency = OneThirdOBs, LZFeq.aov.results)

LZFeq.aov.stderr = data.frame(LZFeq.aov.stderr)
LZFeq.aov.stderr = cbind(frequency = OneThirdOBs, LZFeq.aov.stderr)

LZFeq.aov.predvals = data.frame(LZFeq.aov.predvals)
names(LZFeq.aov.predvals) = pred_frame$treatment
LZFeq.aov.predvals = cbind(frequency = OneThirdOBs, LZFeq.aov.predvals)

LZFeq.aov.predse = data.frame(LZFeq.aov.predse)
names(LZFeq.aov.predse) = pred_frame$treatment
LZFeq.aov.predse = cbind(frequency = OneThirdOBs, LZFeq.aov.predse)

## Write output to files
names(LZFeq.aov.results)[grep('Intercept', names(LZFeq.aov.results))] = 'Baseline'
names(LZFeq.aov.stderr)[grep('Intercept', names(LZFeq.aov.stderr))] = 'Baseline'

write.csv(LZFeq.aov.results, file.path(rootdir, 'LZFeq_2019_ANOVA_Coefficients.csv'), row.names = F)
write.csv(LZFeq.aov.stderr, file.path(rootdir, 'LZFeq_2019_ANOVA_StdErr.csv'), row.names = F)

write.csv(LZFeq.aov.predvals, file.path(rootdir, 'LZFeq_2019_ANOVA_PredictedVals.csv'), row.names = F)
write.csv(LZFeq.aov.predse, file.path(rootdir, 'LZFeq_2019_ANOVA_PredictedVals_StdErr.csv'), row.names = F)

``` 

## Post-hoc ANOVAs by LZFeq Frequency

Plotting ANOVA change in LZFeq from pretreatment, comparing 2019 measurements to 2016. 

Response variables: treatment, pavement temperature, and speed, as well as the interactions between treatment and speed, as well as pavement temperature and speed.

The plots are generated from the output of the statistical models, holding pavement temperature constant at 90 degrees and speed constant at 50 mph. The change in LZFeq is calculated as the difference between the predicted sound levels at 90 degrees and 50 mph for a particular treatment, compared to the baseline pavement conditions in 2016 in the same conditions. The error bars are the standard errors for predicted LZFeq values.

The predicted values at these conditions are saved as `LZFeq_2019_ANOVA_PredictedVals.csv` and `LZFeq_2019_ANOVA_PredictedVals_StdErr.csv`

The plots below became figure 29-32 in the DEVA QPP 1 year report.

```{r plotting_change_LZFeq 2019, fig.height = 20, fig.width = 15}

y_range = c(-10, 10)

## Use predvals. Subtract from baseline to show difference.
predvals = LZFeq.aov.predvals
predse = LZFeq.aov.predse

predvals[,3:6] = predvals[,3:6] - predvals[,2]

## Set colors for each point for 1/4 in chip seal
CS_1.4_col = c()
CS_1.4_col = ifelse(abs(predvals$X1.4in.Chip.Seal) > predse$X1.4in.Chip.Seal,
       ifelse(predvals$X1.4in.Chip.Seal < 0, "blue", "red"),"gray")

## Plot LZFeq 1/4in Chip Seal.
## Since now we are including interaction between speed and treatment, also add the coefficient for the treatment at 50 mph
LZFeq_Chip.Seal.1.4 = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency,
                      y = X1.4in.Chip.Seal,
                      ymin = X1.4in.Chip.Seal - predse$X1.4in.Chip.Seal,
                      ymax = X1.4in.Chip.Seal + predse$X1.4in.Chip.Seal),
                  colour = CS_1.4_col,
                  size =1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = 'One Year LZFeq ANOVA 1/4" Chip Seal Coefficients', 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0) +
  ylim(y_range[1], y_range[2])

## Set colors for each point in 3/8 in chip seal
CS_3.8_col = c()
CS_3.8_col = ifelse(abs(predvals$X3.8in.Chip.Seal) > predse$X3.8in.Chip.Seal,
       ifelse(predvals$X3.8in.Chip.Seal < 0, "blue", "red"),"gray")

## Plot LZFeq 3/8 in chip seal
LZFeq_Chip.Seal.3.8 = ggplot()+
  geom_pointrange(data = predvals, 
                  aes(x = frequency,
                      y = X3.8in.Chip.Seal,
                      ymin = X3.8in.Chip.Seal - predse$X3.8in.Chip.Seal,
                      ymax =X3.8in.Chip.Seal + predse$X3.8in.Chip.Seal),
                  colour = CS_3.8_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = 'One Year LZFeq ANOVA 3/8" Chip Seal Coefficients', 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Set colors for each point in type II microsurfacing
TII_Micro_col = c()
TII_Micro_col = ifelse(abs(predvals$Type.II.Microsurfacing)>predse$Type.II.Microsurfacing,
       ifelse(predvals$Type.II.Microsurfacing<0, "blue", "red"),"gray")

## Plot LZFeq type II microsurfacing
LZFeq_Microsurfacing.II = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.II.Microsurfacing,
                  ymin=Type.II.Microsurfacing - predse$Type.II.Microsurfacing,
                  ymax=Type.II.Microsurfacing + predse$Type.II.Microsurfacing),
                  colour = TII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "One Year LZFeq ANOVA Type II Microsurfacing Coefficients", 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Set colors for each point in type III microsurfacing
TIII_Micro_col = c()
TIII_Micro_col = ifelse(abs(predvals$Type.III.Microsurfacing)>predse$Type.III.Microsurfacing,
       ifelse(predvals$Type.III.Microsurfacing<0, "blue", "red"),"gray")

## Plot LZFeq Type III microsurfacing
LZFeq_Microsurfacing.III = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.III.Microsurfacing,
                  ymin=Type.III.Microsurfacing - predse$Type.III.Microsurfacing,
                  ymax=Type.III.Microsurfacing + predse$Type.III.Microsurfacing),
                  colour = TIII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "One Year LZFeq ANOVA Type III Microsurfacing Coefficients", 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Arrange plots in grid
grid.arrange(LZFeq_Chip.Seal.1.4,LZFeq_Chip.Seal.3.8,LZFeq_Microsurfacing.II, LZFeq_Microsurfacing.III, nrow = 4)

```

## Plotting standardized curves

The following shows the predicted LZFeq values at standardized pavement temperature (90 degrees) and vehicle speed (50 mph). Two versions are shown, a point plot and a 'ribbon plot'. Both show the predicted values, +/- 1 standard error. 

The second plot is interactive; clicking on the legend will show or hide a specific treatment.

```{r plotting_curves_LZFeq 2019, fig.height = 8, fig.width = 10}

## Use predvals
predvals = LZFeq.aov.predvals
predse = LZFeq.aov.predse

predvals = gather(predvals, key = 'treatment', value = 'LZFeq',
                  baseline_chipseal, X3.8in.Chip.Seal, X1.4in.Chip.Seal, Type.II.Microsurfacing, Type.III.Microsurfacing)

predse = gather(predse, key = 'treatment', value = 'SE',
                  baseline_chipseal, X3.8in.Chip.Seal, X1.4in.Chip.Seal, Type.II.Microsurfacing, Type.III.Microsurfacing)

predvals = left_join(predvals, predse)

## Plot 

point_plot <- ggplot(predvals, aes(x = frequency,
                     y = LZFeq,
                     color = treatment)) +
  geom_pointrange(aes(ymin = LZFeq - SE,
                      ymax = LZFeq + SE), 
                      size = 1) +
  # geom_smooth() + 
  geom_line() + 
  theme_bw(base_line_size = 1,
           base_size = 15) +
  scale_x_log10() +
  labs(title = "One Year LZFeq by Surface Treatment \nat 90 deg F pavement temperature and 50 mph speed", 
       x = "Frequency (Hz)", 
       y = "LZFeq (dB)")

point_plot

# Ribbons
ribbon_plot <- ggplot(predvals, aes(x = frequency,
                     y = LZFeq,
                     color = treatment)) +
  geom_ribbon(aes(ymin = LZFeq - SE,
              ymax = LZFeq + SE, 
              fill = treatment,
              color = NULL),
              alpha = 0.3) +
    geom_line() + 

  theme_bw(base_line_size = 1,
           base_size = 15) +
  scale_x_log10() +
  labs(title = "One Year LZFeq by Surface Treatment \nat 90 deg F pavement temperature and 50 mph speed", 
       x = "Frequency (Hz)", 
       y = "LZFeq (dB)")

ggplotly(ribbon_plot)

  
```
# 2021 MANOVA Analysis with LZFeq

```{r manova_2021 with LZFeq}

LZFeq_l_21 = filter(LZFeq_l, Year %in% c("2016", "2021")) # Save a 2016 to 2021 comparison dataset

### model selection:
## conduct partial F test of full model with all predictors against concise models with fewer predictors
## (pavetemp:treatment interaction not possible because one site had constant pavetemp)
full.model = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                     X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed +  pavetemp + pavetemp:speed + treatment:speed, data = LZFeq_l_21)

no.pavetemp = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                      X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed, data = LZFeq_l_21)

#anova(full.model,no.pavetemp) # partial F-stat is significant, thus the no.interactions model leaves variance unexplained

no.interactions = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                      X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp, data = LZFeq_l_21)

#anova(full.model,no.interactions) # partial F-stat is significant, thus the no.interactions model leaves variance unexplained

treatment.speed = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                     X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp + treatment:speed, data = LZFeq_l_21)

#anova(full.model,treatment.speed) # partial F-stat is significant, thus the treatment.speed model leaves variance unexplained

speed.pavetemp = manova(cbind(X50, X63, X80,X100,X125,X160,X200,X250,X315,X400,X500,
                    X630,X800,X1000,X1250,X1600,X2000,X2500,X3150,X4000) ~ treatment + speed + pavetemp+ pavetemp:speed, data = LZFeq_l_21)

#anova(full.model,speed.pavetemp) # partial F-stat is significant, thus the speed.pavetemp model leaves variance unexplained

final.model = full.model # all concise models had significant partial F-statistics, therefore the full model is the best model

finalmodel.coeff = coefficients(final.model)
```

Measured data can be affected by vehicle speed, pavement type, pavement temperature, and the interactions between these main effects. In order to further isolate the effect of pavement type, a Multiple Analysis of Variance (MANOVA) was conducted using measurements from the pre-treatment and post-treatment conditions. The predictors in the MANOVA include the surface treatment, vehicle speed, and pavement temperature. The response variables are the one-third octave band levels associated with the pass-by for each event. In contrast to an ANOVA model, the response in the statistical model is a matrix (number of observations × number of one-third octave bands as response variables) rather than a single vector (number of observations × one response variable). This analysis allows the greatest amount of data to be utilized in order to isolate the contribution of pavement type on the difference in measured levels.

Model selection was conducted to determine the most parsimonious MANOVA model with the fewest predictive parameters that would explain the most change in the response variable matrix. An array of concise models containing a unique subset of the predictor variables was evaluated against a model containing all predictors. The full list of predictors includes the main effects (i.e., surface treatment, vehicle speed, and pavement temperature) and interaction effects (i.e., statistical interaction between vehicle speed and pavement temperature, as well as the interaction between surface treatment and vehicle speed).  Partial F-statistics were computed to compare each concise model against the full model, in which a large and significant F-statistic indicates that the concise model fails to capture a significant amount of variance in the response data due to the deleted predictive parameters. The statistical significance of the partial F-statistic is determined based on the p-value. For this analysis, a p-value less than 0.05 is considered statistically significant. This threshold corresponds to a 95% likelihood that the measured differences in LZFeq data for each pass-by are attributable to the predictor variables in the full model, and did not occur simply by chance. As shown in (Table 5 in the 3.5-year measurement report), all concise models containing a subset of the predictors produced significant partial F-statistics with p-values below 0.05, meaning the full model containing all predictor variables is the best model to use for the statistical analysis. 

The table (Table 6 in the 3.5-year measurement report) shows the summary of the MANOVA statistical test for the difference in sound pressure level (LZFeq) across all 1/3 octave bands attributable to each of the predictors. Note that only 1/3 octave bands from 50 Hz to 4 kHz were included in this analysis. The high frequency analysis limit is due to the internal noise floor of the measurement equipment, which results in poor signal to noise ratio at high frequencies in areas with low ambient noise, such as Death Valley. The first column in the table displays the parameters being evaluated for their impact on the matrix of LZFeq 1/3 octave band data measured for each pass-by. The parameters being evaluated in this data set include either a main effect (surface treatment, vehicle speed, and pavement temperature) or an interaction effect (statistical interaction between vehicle speed and pavement temperature, as well as the interaction between surface treatment and vehicle speed). The second column shows the number of degrees of freedom associated with each parameter, which indicates the number of unique options that can vary. The third column is an estimate of Pillai’s trace, which is a test statistic used in multivariate analyses to evaluate the predictive power of each parameter. A larger Pillai’s value indicates that the parameter is responsible for a greater portion of the difference in spectral LZFeq observed between each pass-by. In order to interpret the statistical significance of this test statistic, we examine the p-value, which is shown in the final column of the table. For this analysis, a p-value less than 0.05 is considered statistically significant. This threshold corresponds to a 95% likelihood that the measured differences in LZFeq data for each pass-by are attributable to the predictor variable, and did not occur simply by chance. The other columns in the table display the approximate F-statistic, (another means of evaluating the statistical significance of predictor variables in which a higher value indicates a greater impact on the response data), and the degrees of freedom for the numerator and denominator in the F-statistics.

The MANOVA indicates that there are strong, statistically significant effects on the noise levels across the frequency spectra for most predictors included in the analysis. All predictors are statistically significant at a level of $\alpha$=0.05 except for the interactive effect of vehicle speed and pavement temperature, as the p-value of Pillai’s test statistic is greater than 0.05. Surface treatment and vehicle speed are the strongest independent predictors of noise, as they both have large Pillai values with corresponding p-values less than 0.001. The latter can be interpreted as a greater than 99% chance that the LZFeq difference measured between pass-bys can be confidently attributed to surface treatment and vehicle speed.
 
```{r overall summary 2021}
sum_2021 <- summary(final.model)

sum_2021$stats[,2] <- round(sum_2021$stats[,2], 3)
sum_2021$stats[,3] <- round(sum_2021$stats[,3], 3)

sum_2021$stats[,6] <- ifelse(sum_2021$stats[,6] < 0.001, '< 0.001', round(sum_2021$stats[,6], 3))
sum_2021$stats[is.na(sum_2021$stats)] = ""

kable(sum_2021$stats,
      align = 'r',
      caption = "Summary of MANOVA analysis for 3.5-years post-treatment (2021) compared to pre-treatment (2016)",
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

write.csv(sum_2021$stats, file = 'MANOVA_2021.csv')
                  

```

```{r manova_post_hoc with LZFeq 2021}
LZFeq.aov.results = vector()
LZFeq.aov.stderr = vector()
OneThirdOBs = vector()
LZFeq.aov.predvals = vector()
LZFeq.aov.predse = vector()

## Creating 'standardized' values using predict. This evens out the pavetemp and speed to a uniform comparison
pt = 90
sp = 50

pred_frame = expand.grid(treatment = unique(LZFeq_l_21$treatment),
                         speed = sp,
                         pavetemp = pt)


for (freq in names(LZFeq_l_21[17:36])){
  an.results = lm(LZFeq_l_21[[freq]]  ~ treatment + speed +  pavetemp + pavetemp:speed + treatment:speed, data = LZFeq_l_21)
  
  OneThirdOBs = rbind(OneThirdOBs, c(as.numeric(substr(freq, 2, nchar(freq)))))
  LZFeq.aov.results = rbind(LZFeq.aov.results, coef(an.results))
  LZFeq.aov.stderr = rbind(LZFeq.aov.stderr, coef(summary(an.results))[,"Std. Error"])
  
  ## Predict 
  pred = predict(an.results, pred_frame, se.fit = T, interval = 'none')
  LZFeq.aov.predvals = rbind(LZFeq.aov.predvals, pred$fit)
  LZFeq.aov.predse = rbind(LZFeq.aov.predse, pred$se.fit)  
  
}

LZFeq.aov.results = data.frame(LZFeq.aov.results)
LZFeq.aov.results = cbind(frequency = OneThirdOBs, LZFeq.aov.results)

LZFeq.aov.stderr = data.frame(LZFeq.aov.stderr)
LZFeq.aov.stderr = cbind(frequency = OneThirdOBs, LZFeq.aov.stderr)

LZFeq.aov.predvals = data.frame(LZFeq.aov.predvals)
names(LZFeq.aov.predvals) = pred_frame$treatment
LZFeq.aov.predvals = cbind(frequency = OneThirdOBs, LZFeq.aov.predvals)

LZFeq.aov.predse = data.frame(LZFeq.aov.predse)
names(LZFeq.aov.predse) = pred_frame$treatment
LZFeq.aov.predse = cbind(frequency = OneThirdOBs, LZFeq.aov.predse)

## Write output to files
names(LZFeq.aov.results)[grep('Intercept', names(LZFeq.aov.results))] = 'Baseline'
names(LZFeq.aov.stderr)[grep('Intercept', names(LZFeq.aov.stderr))] = 'Baseline'

write.csv(LZFeq.aov.results, file.path(rootdir, 'LZFeq_2021_ANOVA_Coefficients.csv'), row.names = F)
write.csv(LZFeq.aov.stderr, file.path(rootdir, 'LZFeq_2021_ANOVA_StdErr.csv'), row.names = F)

write.csv(LZFeq.aov.predvals, file.path(rootdir, 'LZFeq_2021_ANOVA_PredictedVals.csv'), row.names = F)
write.csv(LZFeq.aov.predse, file.path(rootdir, 'LZFeq_2021_ANOVA_PredictedVals_StdErr.csv'), row.names = F)

``` 
## Post-hoc ANOVAs by LZFeq Frequency

Once the statistical significance of the MANOVA was established, it was appropriate to conduct single Analyses of Variance (ANOVAs) for each one-third octave band frequency using this model to determine the effects of each parameter on sound level. 

The below plots (figures 42-45 in the 3.5-year report) illustrate the current difference in spectral LZFeq from pre-treatment, after three and a half years of use. The plots are generated from the output of the ANOVA models based on 2021 measured data, holding vehicle speed constant at 50 mph and pavement temperature constant at 90 degrees Fahrenheit to isolate the effect of the surface treatments. The change in LZFeq after three and a half years is calculated as the difference between the predicted sound levels at 50 mph and $90^{\circ}F$ for a particular treatment in 2021, compared to the baseline pavement conditions in 2016 under the same vehicle speed and pavement temperature conditions. The predicted values and standard errors at these conditions are saved as `LZFeq_2021_ANOVA_PredictedVals.csv` and `LZFeq_2021_ANOVA_PredictedVals_StdErr.csv`

Note that in these figures the error bars are based on ± 1 standard error, which provides a confidence interval of 68.3%, rather than the typical ± 1.96 standard errors, which provides a 95% confidence interval. This was done to help highlight potential differences. Because this interval is less conservative, as new data are added, some trends may change. From these figures, the following conclusions can be drawn:

- The 3/8" chip seal pavement attenuates more high frequency content but less mid frequency content than the pre-treatment, older 3/8" chip seal pavement.
- Similar to the results after one year, the type III microsurfacing after three and a half years of use still attenuates less low frequency content than the pre-treatment pavement baseline.

```{r plotting_change_LZFeq 2021, fig.height = 20, fig.width = 15}

y_range = c(-10, 10)

## Use predvals. Subtract from baseline to show difference.
predvals = LZFeq.aov.predvals
predse = LZFeq.aov.predse

predvals[,3:6] = predvals[,3:6] - predvals[,2]


## Set colors for each point in 3/8 in chip seal
CS_3.8_col = c()
CS_3.8_col = ifelse(abs(predvals$X3.8in.Chip.Seal) > predse$X3.8in.Chip.Seal,
       ifelse(predvals$X3.8in.Chip.Seal < 0, "blue", "red"),"gray")

## Plot LZFeq 3/8 in chip seal
LZFeq_Chip.Seal.3.8 = ggplot()+
  geom_pointrange(data = predvals, 
                  aes(x = frequency,
                      y = X3.8in.Chip.Seal,
                      ymin = X3.8in.Chip.Seal - predse$X3.8in.Chip.Seal,
                      ymax =X3.8in.Chip.Seal + predse$X3.8in.Chip.Seal),
                  colour = CS_3.8_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = 'S01: 3/8" Chip Seal', 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Set colors for each point for 1/4 in chip seal
CS_1.4_col = c()
CS_1.4_col = ifelse(abs(predvals$X1.4in.Chip.Seal) > predse$X1.4in.Chip.Seal,
       ifelse(predvals$X1.4in.Chip.Seal < 0, "blue", "red"),"gray")

## Plot LZFeq 1/4in Chip Seal.
## Since now we are including interaction between speed and treatment, also add the coefficient for the treatment at 50 mph
LZFeq_Chip.Seal.1.4 = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency,
                      y = X1.4in.Chip.Seal,
                      ymin = X1.4in.Chip.Seal - predse$X1.4in.Chip.Seal,
                      ymax = X1.4in.Chip.Seal + predse$X1.4in.Chip.Seal),
                  colour = CS_1.4_col,
                  size =1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = 'S02: 1/4" Chip Seal', 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0) +
  ylim(y_range[1], y_range[2])

## Set colors for each point in type II microsurfacing
TII_Micro_col = c()
TII_Micro_col = ifelse(abs(predvals$Type.II.Microsurfacing)>predse$Type.II.Microsurfacing,
       ifelse(predvals$Type.II.Microsurfacing<0, "blue", "red"),"gray")

## Plot LZFeq type II microsurfacing
LZFeq_Microsurfacing.II = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.II.Microsurfacing,
                  ymin=Type.II.Microsurfacing - predse$Type.II.Microsurfacing,
                  ymax=Type.II.Microsurfacing + predse$Type.II.Microsurfacing),
                  colour = TII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "S03: Type II Microsurfacing", 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Set colors for each point in type III microsurfacing
TIII_Micro_col = c()
TIII_Micro_col = ifelse(abs(predvals$Type.III.Microsurfacing)>predse$Type.III.Microsurfacing,
       ifelse(predvals$Type.III.Microsurfacing<0, "blue", "red"),"gray")

## Plot LZFeq Type III microsurfacing
LZFeq_Microsurfacing.III = ggplot()+
  geom_pointrange(data = predvals,
                  aes(x = frequency, 
                  y = Type.III.Microsurfacing,
                  ymin=Type.III.Microsurfacing - predse$Type.III.Microsurfacing,
                  ymax=Type.III.Microsurfacing + predse$Type.III.Microsurfacing),
                  colour = TIII_Micro_col,
                  size = 1) +
  theme_bw(base_line_size = 1,
           base_size = 20)+
  scale_x_log10()+
  labs(title = "S04: Type III Microsurfacing", 
       x = "Frequency (Hz)", 
       y = "LZFeq Difference \nfrom Pre-Treatment (dB)")  + 
  geom_hline(yintercept = 0)+
  ylim(y_range[1], y_range[2])

## Arrange plots in grid
grid.arrange(LZFeq_Chip.Seal.3.8,LZFeq_Chip.Seal.1.4,LZFeq_Microsurfacing.II, LZFeq_Microsurfacing.III, nrow = 2,  top = textGrob("3.5-Year LZFeq ANOVA Difference from Pre-treatment", gp=gpar(fontsize=35)))

```

## Plotting standardized curves

The following shows the predicted LZFeq values at standardized vehicle speed (50 mph) and pavement temperature ( $90^{\circ}F$). Two versions are shown, a point plot and a 'ribbon plot'. Both show the predicted values, +/- 1 standard error. 

The second plot is interactive; clicking on the legend will show or hide a specific treatment.

```{r plotting_curves_LZFeq 2021, fig.height = 8, fig.width = 10}

## Use predvals
predvals = LZFeq.aov.predvals
predse = LZFeq.aov.predse

predvals = gather(predvals, key = 'treatment', value = 'LZFeq',
                  baseline_chipseal, X3.8in.Chip.Seal, X1.4in.Chip.Seal, Type.II.Microsurfacing, Type.III.Microsurfacing)

predse = gather(predse, key = 'treatment', value = 'SE',
                  baseline_chipseal, X3.8in.Chip.Seal, X1.4in.Chip.Seal, Type.II.Microsurfacing, Type.III.Microsurfacing)

predvals = left_join(predvals, predse)

## Plot 

point_plot <- ggplot(predvals, aes(x = frequency,
                     y = LZFeq,
                     color = treatment)) +
  geom_pointrange(aes(ymin = LZFeq - SE,
                      ymax = LZFeq + SE), 
                      size = 1) +
  geom_line() + 
  theme_bw(base_line_size = 1,
           base_size = 15) +
  scale_x_log10() +
  labs(title = "3.5-Year LZFeq by Surface Treatment \nat 50mph vehicle speed & 90°F pavement temp", 
       x = "Frequency (Hz)", 
       y = "LZFeq (dB)")

point_plot

## Ribbons
ribbon_plot <- ggplot(predvals, aes(x = frequency,
                     y = LZFeq,
                     color = treatment)) +
  geom_ribbon(aes(ymin = LZFeq - SE,
              ymax = LZFeq + SE, 
              fill = treatment,
              color = NULL),
              alpha = 0.3) +
    geom_line() + 

  theme_bw(base_line_size = 1,
           base_size = 15) +
  scale_x_log10() +
  labs(title = "3.5-Year LZFeq by Surface Treatment \nat 50mph vehicle speed & 90°F pavement temp", 
       x = "Frequency (Hz)", 
       y = "LZFeq (dB)")

ggplotly(ribbon_plot)

  
```